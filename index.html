<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>写本異読確認ツール - 6写本対応</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;700&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <link rel="styleshee" href="" type "text/css"
</head>
<body>
    <div class="header">
        <h1>写本異読確認ツール - 複数写本対応</h1>
        <div class="load-buttons">
            <button class="load-btn" onclick="showTextInputDialog()">まとめて入力</button>
            <button class="load-btn" onclick="clearAllTexts()">全クリア</button>
        </div>
        <div class="manuscript-selector">
            <div class="manuscript-count-control">
                <span>写本数:</span>
                <select class="count-select" id="manuscriptCountSelect" onchange="updateManuscriptCount()">
                    <option value="2">2写本</option>
                    <option value="3">3写本</option>
                    <option value="4">4写本</option>
                    <option value="5">5写本</option>
                    <option value="6" selected>6写本</option>
                    <option value="8">8写本</option>
                    <option value="9">9写本</option>
                    <option value="12">12写本</option>
                </select>
            </div>
            <button class="load-btn" onclick="addManuscriptPanel()">+ 写本追加</button>
            <span class="manuscript-count" id="manuscriptCount">6写本を比較中</span>
        </div>
    </div>

    <div class="container" id="manuscriptContainer">
        <!-- 解析結果パネル（右側、2段分の高さ） -->
        <div class="results-panel">
            <div class="results-header">
                <div class="results-title-row">
                    <div class="results-title">異読解析結果</div>
                    <div class="results-controls">
                        <button class="results-btn" onclick="updateDiff()">解析</button>
                        <button class="results-btn" onclick="exportResults()">出力</button>
                    </div>
                </div>
                <div class="legend">
                    <div class="legend-item">
                        <span class="legend-color variant"></span>
                        <span>異読</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color unique"></span>
                        <span>独自</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color common"></span>
                        <span>共通</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color same"></span>
                        <span>一致</span>
                    </div>
                </div>
            </div>
            <div class="results-content" id="resultsContent">写本を入力して「解析」ボタンを押してください</div>
        </div>
        <!-- 写本パネルは動的に生成される -->
    </div>

    <!-- テスト入力ダイアログ -->
    <div class="dialog-overlay" id="textInputDialog">
        <div class="dialog">
            <h3>写本テキスト入力</h3>
            <div class="target-selector">
                <span style="font-size: 14px; margin-bottom: 8px; display: block;">写本を選択:</span>
                <div id="manuscriptRadioButtons" style="display: flex; flex-wrap: wrap; gap: 15px;">
                    <!-- ラジオボタンは動的に生成される -->
                </div>
            </div>
            <textarea class="dialog-input" id="testTextInput" placeholder="写本のテキストをここに入力してください...

アラビア語写本の例:
بسم الله الرحمن الرحيم
الحمد لله رب العالمين
الرحمن الرحيم
مالك يوم الدين

異なる写本間での表記揺れや語句の違いを確認できます。"></textarea>
            <div class="dialog-buttons">
                <button class="dialog-btn secondary" onclick="closeTextInputDialog()">キャンセル</button>
                <button class="dialog-btn primary" onclick="applyTestText()">適用</button>
            </div>
        </div>
    </div>

    <script>
        let currentManuscriptCount = 6;
        let manuscriptNames = ['写本A', '写本B', '写本C', '写本D', '写本E', '写本F', '写本G', '写本H', '写本I', '写本J', '写本K', '写本L'];
        let manuscriptPanels = [1, 2, 3, 4, 5, 6]; // アクティブなパネルIDを管理
        let nextPanelId = 7; // 次に作成するパネルID

        function addManuscriptPanel() {
            if (manuscriptPanels.length >= 12) {
                alert('最大12写本まで対応しています');
                return;
            }

            const panelId = nextPanelId++;
            manuscriptPanels.push(panelId);
            
            const container = document.getElementById('manuscriptContainer');
            const addButton = container.querySelector('.add-panel-btn');
            
            const panel = document.createElement('div');
            panel.className = 'panel';
            panel.id = `panel${panelId}`;
            
            const defaultName = `写本${String.fromCharCode(65 + manuscriptPanels.length - 1)}`;
            
            panel.innerHTML = `
                <div class="panel-header">
                    <input type="text" class="panel-title" value="${defaultName}" 
                           onchange="updateManuscriptName(${panelId}, this.value)" 
                           onblur="updateManuscriptName(${panelId}, this.value)"
                           placeholder="写本名">
                    <div class="panel-controls">
                        <button class="panel-btn" onclick="clearText(${panelId})">クリア</button>
                        <button class="panel-btn" onclick="pasteFromClipboard(${panelId})">貼付</button>
                        <button class="panel-btn danger" onclick="removeManuscriptPanel(${panelId})" title="この写本を削除">×</button>
                    </div>
                </div>
                <div class="content">
                    <div class="line-numbers" id="lineNumbers${panelId}"></div>
                    <textarea class="textarea-input" id="text${panelId}" 
                              placeholder="${defaultName}のテキスト..." 
                              oninput="updateDiff(); updateStatus(${panelId})"></textarea>
                </div>
                <div class="status" id="status${panelId}">テキストを入力</div>
            `;
            
            if (addButton) {
                container.insertBefore(panel, addButton);
            } else {
                container.appendChild(panel);
            }
            
            // イベントリスナーを追加
            document.getElementById(`text${panelId}`).addEventListener('input', function() {
                updateLineNumbers(`text${panelId}`, `lineNumbers${panelId}`);
                updateStatus(panelId);
            });
            
            updateStatus(panelId);
            updateManuscriptCountDisplay();
            updateGridLayoutDynamic();
            updateDialogRadioButtons();
            updateDiff();
        }

        function removeManuscriptPanel(panelId) {
            if (manuscriptPanels.length <= 2) {
                alert('最低2つの写本が必要です');
                return;
            }

            if (confirm('この写本を削除しますか？入力されたテキストは失われます。')) {
                const panel = document.getElementById(`panel${panelId}`);
                if (panel) {
                    panel.remove();
                }
                
                manuscriptPanels = manuscriptPanels.filter(id => id !== panelId);
                updateManuscriptCountDisplay();
                updateGridLayoutDynamic();
                updateDialogRadioButtons();
                updateDiff();
            }
        }

        function updateManuscriptCountDisplay() {
            document.getElementById('manuscriptCount').textContent = `${manuscriptPanels.length}写本を比較中`;
            
            // セレクトボックスの値も更新
            const select = document.getElementById('manuscriptCountSelect');
            const currentCount = manuscriptPanels.length;
            
            // 対応する値がない場合は最も近い値を選択
            const options = Array.from(select.options).map(opt => parseInt(opt.value));
            const closestOption = options.reduce((prev, curr) => 
                Math.abs(curr - currentCount) < Math.abs(prev - currentCount) ? curr : prev
            );
            select.value = closestOption;
        }

        function updateGridLayoutDynamic() {
            const container = document.getElementById('manuscriptContainer');
            const count = manuscriptPanels.length;
            
            if (count === 2) {
                // 2写本: 横並び、1行で最大化
                container.style.gridTemplateColumns = '1fr 1fr 400px';
                container.style.gridTemplateRows = '1fr';
            } else if (count === 3) {
                // 3写本: 横並び、1行で最大化
                container.style.gridTemplateColumns = '1fr 1fr 1fr 400px';
                container.style.gridTemplateRows = '1fr';
            } else if (count === 4) {
                // 4写本: 2×2配置
                container.style.gridTemplateColumns = '1fr 1fr 400px';
                container.style.gridTemplateRows = '1fr 1fr';
            } else if (count === 5) {
                // 5写本: 3+2配置
                container.style.gridTemplateColumns = '1fr 1fr 1fr 400px';
                container.style.gridTemplateRows = '1fr 1fr';
            } else if (count === 6) {
                // 6写本: 3×2配置
                container.style.gridTemplateColumns = '1fr 1fr 1fr 400px';
                container.style.gridTemplateRows = '1fr 1fr';
            } else if (count <= 8) {
                // 7-8写本: 4×2配置
                container.style.gridTemplateColumns = '1fr 1fr 1fr 1fr 400px';
                container.style.gridTemplateRows = '1fr 1fr';
            } else if (count === 9) {
                // 9写本: 3×3配置
                container.style.gridTemplateColumns = '1fr 1fr 1fr 400px';
                container.style.gridTemplateRows = '1fr 1fr 1fr';
            } else {
                // 10-12写本: 4×3配置
                container.style.gridTemplateColumns = '1fr 1fr 1fr 1fr 400px';
                container.style.gridTemplateRows = '1fr 1fr 1fr';
            }
            
            // 追加ボタンの表示/非表示
            updateAddButton();
        }

        function updateAddButton() {
            const container = document.getElementById('manuscriptContainer');
            let addButton = container.querySelector('.add-panel-btn');
            
            // 追加ボタンが存在する場合は削除
            if (addButton) {
                addButton.remove();
            }
        }

        function updateManuscriptCount() {
            const select = document.getElementById('manuscriptCountSelect');
            const newCount = parseInt(select.value);
            
            // 現在のパネル数と比較して調整
            if (newCount > manuscriptPanels.length) {
                // パネルを追加
                while (manuscriptPanels.length < newCount) {
                    addManuscriptPanel();
                }
            } else if (newCount < manuscriptPanels.length) {
                // パネルを削除
                while (manuscriptPanels.length > newCount && manuscriptPanels.length > 2) {
                    const lastPanelId = manuscriptPanels[manuscriptPanels.length - 1];
                    const panel = document.getElementById(`panel${lastPanelId}`);
                    if (panel) {
                        panel.remove();
                    }
                    manuscriptPanels.pop();
                }
            }
            
            currentManuscriptCount = manuscriptPanels.length;
            updateManuscriptCountDisplay();
            updateGridLayoutDynamic();
            updateDialogRadioButtons();
            updateDiff();
        }

        function updateGridLayout(count) {
            // この関数は updateGridLayoutDynamic に統合されました
            updateGridLayoutDynamic();
        }

        function generateManuscriptPanels(count) {
            const container = document.getElementById('manuscriptContainer');
            
            // 既存の写本パネルを削除（結果パネル以外）
            const existingPanels = container.querySelectorAll('.panel:not(.results-panel)');
            existingPanels.forEach(panel => panel.remove());
            const addButton = container.querySelector('.add-panel-btn');
            if (addButton) addButton.remove();
            
            // パネルIDをリセット
            manuscriptPanels = [];
            nextPanelId = 1;
            
            // 新しいパネルを生成
            for (let i = 1; i <= count; i++) {
                const panelId = i;
                manuscriptPanels.push(panelId);
                
                const panel = document.createElement('div');
                panel.className = 'panel';
                panel.id = `panel${panelId}`;
                
                panel.innerHTML = `
                    <div class="panel-header">
                        <input type="text" class="panel-title" value="${manuscriptNames[i-1]}" 
                               onchange="updateManuscriptName(${panelId}, this.value)" 
                               onblur="updateManuscriptName(${panelId}, this.value)"
                               placeholder="写本名">
                        <div class="panel-controls">
                            <button class="panel-btn" onclick="clearText(${panelId})">クリア</button>
                            <button class="panel-btn" onclick="pasteFromClipboard(${panelId})">貼付</button>
                            ${count > 2 ? `<button class="panel-btn danger" onclick="removeManuscriptPanel(${panelId})" title="この写本を削除">×</button>` : ''}
                        </div>
                    </div>
                    <div class="content">
                        <div class="line-numbers" id="lineNumbers${panelId}"></div>
                        <textarea class="textarea-input" id="text${panelId}" 
                                  placeholder="${manuscriptNames[i-1]}のテキスト..." 
                                  oninput="updateDiff(); updateStatus(${panelId})"></textarea>
                    </div>
                    <div class="status" id="status${panelId}">テキストを入力</div>
                `;
                
                container.appendChild(panel);
                
                // イベントリスナーを追加
                document.getElementById(`text${panelId}`).addEventListener('input', function() {
                    updateLineNumbers(`text${panelId}`, `lineNumbers${panelId}`);
                    updateStatus(panelId);
                });
                
                // RTL用の初期スクロール位置を設定
                setTimeout(() => {
                    const textarea = document.getElementById(`text${panelId}`);
                    if (textarea) {
                        textarea.scrollLeft = textarea.scrollWidth - textarea.clientWidth;
                    }
                }, 0);
                
                updateStatus(panelId);
            }
            
            nextPanelId = count + 1;
            currentManuscriptCount = count;
            updateAddButton();
            // パネル生成後にレイアウトを更新
            updateGridLayoutDynamic();
        }

        function updateManuscriptName(panelNumber, newName) {
            if (newName.trim()) {
                manuscriptNames[panelNumber - 1] = newName.trim();
                // プレースホルダーも更新
                const textarea = document.getElementById(`text${panelNumber}`);
                if (textarea) {
                    textarea.placeholder = `${newName}のテキスト...`;
                }
                updateDiff(); // 結果表示も更新
            }
        }

        function updateDialogRadioButtons() {
            const container = document.getElementById('manuscriptRadioButtons');
            container.innerHTML = '';
            
            manuscriptPanels.forEach((panelId, index) => {
                const label = document.createElement('label');
                const panelTitle = document.getElementById(`panel${panelId}`)?.querySelector('.panel-title')?.value || `写本${index + 1}`;
                label.innerHTML = `<input type="radio" name="target" value="text${panelId}" ${index === 0 ? 'checked' : ''}> ${panelTitle}`;
                container.appendChild(label);
            });
        }

        function updateLineNumbers(textareaId, lineNumbersId) {
            const textarea = document.getElementById(textareaId);
            const lineNumbers = document.getElementById(lineNumbersId);
            const lines = textarea.value.split('\n');
            const numbers = lines.map((_, index) => index + 1).join('\n');
            lineNumbers.textContent = numbers;
        }

        function clearText(panelNumber) {
            const textareaId = `text${panelNumber}`;
            const statusId = `status${panelNumber}`;
            const lineNumbersId = `lineNumbers${panelNumber}`;
            
            document.getElementById(textareaId).value = '';
            document.getElementById(statusId).textContent = 'クリアしました';
            document.getElementById(lineNumbersId).textContent = '';
            updateDiff();
        }

        function clearAllTexts() {
            manuscriptPanels.forEach(panelId => {
                clearText(panelId);
            });
            document.getElementById('resultsContent').textContent = '全ての写本をクリアしました';
        }

        async function pasteFromClipboard(panelNumber) {
            const textareaId = `text${panelNumber}`;
            const statusId = `status${panelNumber}`;
            const lineNumbersId = `lineNumbers${panelNumber}`;
            
            try {
                const text = await navigator.clipboard.readText();
                if (text) {
                    const textarea = document.getElementById(textareaId);
                    textarea.value = text;
                    document.getElementById(statusId).textContent = '貼り付け完了';
                    updateLineNumbers(textareaId, lineNumbersId);
                    
                    // RTL用のスクロール位置を設定
                    setTimeout(() => {
                        textarea.scrollLeft = textarea.scrollWidth - textarea.clientWidth;
                    }, 0);
                    
                    updateDiff();
                } else {
                    document.getElementById(statusId).textContent = 'クリップボード空';
                }
            } catch (err) {
                document.getElementById(statusId).textContent = 'Ctrl+Vで貼り付け';
            }
        }

        function updateStatus(panelNumber) {
            const textareaId = `text${panelNumber}`;
            const statusId = `status${panelNumber}`;
            const text = document.getElementById(textareaId).value;
            const lines = text.split('\n').length;
            const chars = text.length;
            
            if (chars === 0) {
                document.getElementById(statusId).textContent = 'テキストを入力';
            } else {
                document.getElementById(statusId).textContent = `${lines}行, ${chars}文字`;
            }
        }

        function loadSampleData() {
            // 現在の写本数に応じてサンプルデータを生成
            const baseSamples = [
                `بسم الله الرحمن الرحيم
الحمد لله رب العالمين
الرحمن الرحيم
مالك يوم الدين
إياك نعبد وإياك نستعين
اهدنا الصراط المستقيم`,
                `بسم الله الرحمان الرحيم
الحمد لله رب العالمين
الرحمان الرحيم
ملك يوم الدين
إياك نعبد وإياك نستعين
اهدنا الصراط المستقيم`,
                `بسم الله الرحمن الرحيم
الحمد لله رب العالمين
الرحمن الرحيم
مالك يوم الدين
اياك نعبد واياك نستعين
اهدنا الصراط المستقيم`,
                `بسم الله الرحمن الرحيم
الحمد لله رب العالمين
الرحمن الرحيم
مالك يوم الدين
إياك نعبد وإياك نستعين
اهدنا الصراط المستقيم`,
                `بسم الله الرحمن الرحيم
الحمد لله رب العالمين
الرحمان الرحيم
مالك يوم الدين
إياك نعبد وإياك نستعين
اهدنا الصراط المستقيم`,
                `بسم الله الرحمن الرحيم
الحمد لله رب العالمين
الرحمن الرحيم
ملك يوم الدين
إياك نعبد وإياك نستعين
اهدنا الصراط المستقيم`
            ];

            for (let i = 0; i < currentManuscriptCount; i++) {
                const textareaId = `text${i + 1}`;
                const statusId = `status${i + 1}`;
                const lineNumbersId = `lineNumbers${i + 1}`;
                
                const sampleIndex = i % baseSamples.length;
                const textarea = document.getElementById(textareaId);
                const status = document.getElementById(statusId);
                
                if (textarea && status) {
                    textarea.value = baseSamples[sampleIndex];
                    status.textContent = 'ファーティハ章サンプル';
                    updateLineNumbers(textareaId, lineNumbersId);
                    
                    // RTL用のスクロール位置を設定
                    setTimeout(() => {
                        textarea.scrollLeft = textarea.scrollWidth - textarea.clientWidth;
                    }, 0);
                }
            }
            
            updateDiff();
        }

        function testArabicDisplay() {
            const basicTest = `مرحبا
السلام عليكم
اهلا وسهلا`;

            const textarea = document.getElementById('text1');
            textarea.value = basicTest;
            document.getElementById('status1').textContent = 'アラビア語テスト';
            updateLineNumbers('text1', 'lineNumbers1');
            
            // RTL用のスクロール位置を設定
            setTimeout(() => {
                textarea.scrollLeft = textarea.scrollWidth - textarea.clientWidth;
            }, 0);
            
            updateDiff();
        }

        function updateDiff() {
            const texts = [];
            let hasContent = false;
            
            manuscriptPanels.forEach(panelId => {
                const textElement = document.getElementById(`text${panelId}`);
                if (textElement) {
                    const text = textElement.value;
                    texts.push(text.split('\n'));
                    if (text.trim()) hasContent = true;
                } else {
                    texts.push([]);
                }
            });
            
            if (!hasContent) {
                document.getElementById('resultsContent').textContent = '写本テキストを入力して解析を実行してください';
                return;
            }
            
            const analysis = analyzeManuscripts(texts);
            displayResults(analysis);
        }

        function analyzeManuscripts(manuscripts) {
            const maxLines = Math.max(...manuscripts.map(m => m.length));
            const results = [];
            
            for (let lineNum = 0; lineNum < maxLines; lineNum++) {
                const lineVariants = [];
                const variants = new Set();
                
                for (let i = 0; i < manuscriptPanels.length; i++) {
                    const line = manuscripts[i][lineNum] || '';
                    lineVariants.push(line);
                    if (line.trim()) variants.add(line.trim());
                }
                
                if (variants.size > 1) {
                    results.push({
                        lineNumber: lineNum + 1,
                        variants: lineVariants,
                        variantCount: variants.size,
                        hasVariants: true
                    });
                }
            }
            
            return results;
        }

        function displayResults(analysis) {
            const resultsContent = document.getElementById('resultsContent');
            
            if (analysis.length === 0) {
                resultsContent.textContent = '異読箇所は見つかりませんでした\n\n全ての写本が一致しています。';
                return;
            }
            
            let resultText = `📊 解析サマリー\n異読箇所: ${analysis.length}箇所\n\n`;
            
            analysis.forEach((item, index) => {
                resultText += `━━━━━━━━━━━━━━━━\n`;
                resultText += `🔍 行 ${item.lineNumber} (異読${item.variantCount}種)\n\n`;
                
                const manuscriptLabels = ['A', 'B', 'C', 'D', 'E', 'F'];
                const variants = new Map();
                
                // 同じ異読をグループ化
                for (let i = 0; i < manuscriptPanels.length; i++) {
                    const text = item.variants[i] || '[空行]';
                    if (!variants.has(text)) {
                        variants.set(text, []);
                    }
                    const panelId = manuscriptPanels[i];
                    const panelTitle = document.getElementById(`panel${panelId}`)?.querySelector('.panel-title')?.value || `写本${i + 1}`;
                    variants.get(text).push(panelTitle);
                }
                
                let variantNum = 1;
                variants.forEach((manuscripts, text) => {
                    if (text.trim() && text !== '[空行]') {
                        resultText += `📝 異読${variantNum}: ${manuscripts.join('・')}\n`;
                        resultText += `   ${text}\n\n`;
                        variantNum++;
                    } else if (text === '[空行]') {
                        resultText += `⭕ 空行: ${manuscripts.join('・')}\n\n`;
                    }
                });
            });
            
            resultsContent.textContent = resultText;
        }

        function exportResults() {
            const content = document.getElementById('resultsContent').textContent;
            const blob = new Blob([content], { type: 'text/plain; charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = '写本異読解析結果.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function showTextInputDialog() {
            document.getElementById('textInputDialog').style.display = 'flex';
            document.getElementById('testTextInput').focus();
        }

        function closeTextInputDialog() {
            document.getElementById('textInputDialog').style.display = 'none';
        }

        function applyTestText() {
            const text = document.getElementById('testTextInput').value;
            const target = document.querySelector('input[name="target"]:checked').value;
            
            if (!text.trim()) {
                alert('テキストを入力してください');
                return;
            }

            const panelNumber = target.replace('text', '');
            document.getElementById(target).value = text;
            document.getElementById(`status${panelNumber}`).textContent = 'まとめて入力完了';
            updateLineNumbers(target, `lineNumbers${panelNumber}`);
            
            updateDiff();
            closeTextInputDialog();
        }

        // ESCキーでダイアログを閉じる
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeTextInputDialog();
            }
        });

        // ダイアログの背景クリックで閉じる
        document.getElementById('textInputDialog').addEventListener('click', function(e) {
            if (e.target === this) {
                closeTextInputDialog();
            }
        });

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            // 初期状態で6写本のパネルを生成
            generateManuscriptPanels(6);
            updateDialogRadioButtons();
            // レイアウトを明示的に設定
            updateGridLayoutDynamic();
        });
    </script>
</body>
</html>
