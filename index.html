<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>å†™æœ¬ç•°èª­ç¢ºèªãƒ„ãƒ¼ãƒ« - 6å†™æœ¬å¯¾å¿œ</title>
    <link rel="stylesheet" href="stylesheet.css">
</head>
<body>
    <div class="header">
        <h1>å†™æœ¬ç•°èª­ç¢ºèªãƒ„ãƒ¼ãƒ« - è¤‡æ•°å†™æœ¬å¯¾å¿œ</h1>
        <div class="load-buttons">
            <button class="load-btn" onclick="showTextInputDialog()">ã¾ã¨ã‚ã¦å…¥åŠ›</button>
            <button class="load-btn" onclick="clearAllTexts()">å…¨ã‚¯ãƒªã‚¢</button>
        </div>
        <div class="manuscript-selector">
            <div class="manuscript-count-control">
                <span>å†™æœ¬æ•°:</span>
                <select class="count-select" id="manuscriptCountSelect" onchange="updateManuscriptCount()">
                    <option value="2">2å†™æœ¬</option>
                    <option value="3">3å†™æœ¬</option>
                    <option value="4">4å†™æœ¬</option>
                    <option value="5">5å†™æœ¬</option>
                    <option value="6" selected>6å†™æœ¬</option>
                    <option value="8">8å†™æœ¬</option>
                    <option value="9">9å†™æœ¬</option>
                    <option value="12">12å†™æœ¬</option>
                </select>
            </div>
            <button class="load-btn" onclick="addManuscriptPanel()">+ å†™æœ¬è¿½åŠ </button>
            <span class="manuscript-count" id="manuscriptCount">6å†™æœ¬ã‚’æ¯”è¼ƒä¸­</span>
        </div>
    </div>

    <div class="container" id="manuscriptContainer">
        <!-- è§£æçµæœãƒ‘ãƒãƒ«ï¼ˆå³å´ã€2æ®µåˆ†ã®é«˜ã•ï¼‰ -->
        <div class="results-panel">
            <div class="results-header">
                <div class="results-title-row">
                    <div class="results-title">ç•°èª­è§£æçµæœ</div>
                    <div class="results-controls">
                        <button class="results-btn" onclick="updateDiff()">è§£æ</button>
                        <button class="results-btn" onclick="exportResults()">å‡ºåŠ›</button>
                    </div>
                </div>
                <div class="legend">
                    <div class="legend-item">
                        <span class="legend-color variant"></span>
                        <span>ç•°èª­</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color unique"></span>
                        <span>ç‹¬è‡ª</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color common"></span>
                        <span>å…±é€š</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color same"></span>
                        <span>ä¸€è‡´</span>
                    </div>
                </div>
            </div>
            <div class="results-content" id="resultsContent">å†™æœ¬ã‚’å…¥åŠ›ã—ã¦ã€Œè§£æã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>
        </div>
        <!-- å†™æœ¬ãƒ‘ãƒãƒ«ã¯å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
    </div>

    <!-- ãƒ†ã‚¹ãƒˆå…¥åŠ›ãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
    <div class="dialog-overlay" id="textInputDialog">
        <div class="dialog">
            <h3>å†™æœ¬ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›</h3>
            <div class="target-selector">
                <span style="font-size: 14px; margin-bottom: 8px; display: block;">å†™æœ¬ã‚’é¸æŠ:</span>
                <div id="manuscriptRadioButtons" style="display: flex; flex-wrap: wrap; gap: 15px;">
                    <!-- ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã¯å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
                </div>
            </div>
            <textarea class="dialog-input" id="testTextInput" placeholder="å†™æœ¬ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ã“ã“ã«å…¥åŠ›ã—ã¦ãã ã•ã„...

ã‚¢ãƒ©ãƒ“ã‚¢èªå†™æœ¬ã®ä¾‹:
Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø±Ø­ÙŠÙ…
Ø§Ù„Ø­Ù…Ø¯ Ù„Ù„Ù‡ Ø±Ø¨ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠÙ†
Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø±Ø­ÙŠÙ…
Ù…Ø§Ù„Ùƒ ÙŠÙˆÙ… Ø§Ù„Ø¯ÙŠÙ†

ç•°ãªã‚‹å†™æœ¬é–“ã§ã®è¡¨è¨˜æºã‚Œã‚„èªå¥ã®é•ã„ã‚’ç¢ºèªã§ãã¾ã™ã€‚"></textarea>
            <div class="dialog-buttons">
                <button class="dialog-btn secondary" onclick="closeTextInputDialog()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="dialog-btn primary" onclick="applyTestText()">é©ç”¨</button>
            </div>
        </div>
    </div>

    <script>
        let currentManuscriptCount = 6;
        let manuscriptNames = ['å†™æœ¬A', 'å†™æœ¬B', 'å†™æœ¬C', 'å†™æœ¬D', 'å†™æœ¬E', 'å†™æœ¬F', 'å†™æœ¬G', 'å†™æœ¬H', 'å†™æœ¬I', 'å†™æœ¬J', 'å†™æœ¬K', 'å†™æœ¬L'];
        let manuscriptPanels = [1, 2, 3, 4, 5, 6]; // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ‘ãƒãƒ«IDã‚’ç®¡ç†
        let nextPanelId = 7; // æ¬¡ã«ä½œæˆã™ã‚‹ãƒ‘ãƒãƒ«ID

        function addManuscriptPanel() {
            if (manuscriptPanels.length >= 12) {
                alert('æœ€å¤§12å†™æœ¬ã¾ã§å¯¾å¿œã—ã¦ã„ã¾ã™');
                return;
            }

            const panelId = nextPanelId++;
            manuscriptPanels.push(panelId);
            
            const container = document.getElementById('manuscriptContainer');
            const addButton = container.querySelector('.add-panel-btn');
            
            const panel = document.createElement('div');
            panel.className = 'panel';
            panel.id = `panel${panelId}`;
            
            const defaultName = `å†™æœ¬${String.fromCharCode(65 + manuscriptPanels.length - 1)}`;
            
            panel.innerHTML = `
                <div class="panel-header">
                    <input type="text" class="panel-title" value="${defaultName}" 
                           onchange="updateManuscriptName(${panelId}, this.value)" 
                           onblur="updateManuscriptName(${panelId}, this.value)"
                           placeholder="å†™æœ¬å">
                    <div class="panel-controls">
                        <button class="panel-btn" onclick="clearText(${panelId})">ã‚¯ãƒªã‚¢</button>
                        <button class="panel-btn" onclick="pasteFromClipboard(${panelId})">è²¼ä»˜</button>
                        <button class="panel-btn danger" onclick="removeManuscriptPanel(${panelId})" title="ã“ã®å†™æœ¬ã‚’å‰Šé™¤">Ã—</button>
                    </div>
                </div>
                <div class="content">
                    <div class="line-numbers" id="lineNumbers${panelId}"></div>
                    <textarea class="textarea-input" id="text${panelId}" 
                              placeholder="${defaultName}ã®ãƒ†ã‚­ã‚¹ãƒˆ..." 
                              oninput="updateDiff(); updateStatus(${panelId})"></textarea>
                </div>
                <div class="status" id="status${panelId}">ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›</div>
            `;
            
            if (addButton) {
                container.insertBefore(panel, addButton);
            } else {
                container.appendChild(panel);
            }
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
            document.getElementById(`text${panelId}`).addEventListener('input', function() {
                updateLineNumbers(`text${panelId}`, `lineNumbers${panelId}`);
                updateStatus(panelId);
            });
            
            updateStatus(panelId);
            updateManuscriptCountDisplay();
            updateGridLayoutDynamic();
            updateDialogRadioButtons();
            updateDiff();
        }

        function removeManuscriptPanel(panelId) {
            if (manuscriptPanels.length <= 2) {
                alert('æœ€ä½2ã¤ã®å†™æœ¬ãŒå¿…è¦ã§ã™');
                return;
            }

            if (confirm('ã“ã®å†™æœ¬ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿå…¥åŠ›ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã¯å¤±ã‚ã‚Œã¾ã™ã€‚')) {
                const panel = document.getElementById(`panel${panelId}`);
                if (panel) {
                    panel.remove();
                }
                
                manuscriptPanels = manuscriptPanels.filter(id => id !== panelId);
                updateManuscriptCountDisplay();
                updateGridLayoutDynamic();
                updateDialogRadioButtons();
                updateDiff();
            }
        }

        function updateManuscriptCountDisplay() {
            document.getElementById('manuscriptCount').textContent = `${manuscriptPanels.length}å†™æœ¬ã‚’æ¯”è¼ƒä¸­`;
            
            // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®å€¤ã‚‚æ›´æ–°
            const select = document.getElementById('manuscriptCountSelect');
            const currentCount = manuscriptPanels.length;
            
            // å¯¾å¿œã™ã‚‹å€¤ãŒãªã„å ´åˆã¯æœ€ã‚‚è¿‘ã„å€¤ã‚’é¸æŠ
            const options = Array.from(select.options).map(opt => parseInt(opt.value));
            const closestOption = options.reduce((prev, curr) => 
                Math.abs(curr - currentCount) < Math.abs(prev - currentCount) ? curr : prev
            );
            select.value = closestOption;
        }

function updateGridLayoutDynamic() {
    const container = document.getElementById('manuscriptContainer');
    const count = manuscriptPanels.length;
    
    // è§£æçµæœãƒ‘ãƒãƒ«ã¯å¸¸ã«å›ºå®šä½ç½®ã«é…ç½®
    const resultsPanel = container.querySelector('.results-panel');
    if (resultsPanel) {
        resultsPanel.style.gridColumn = '-2';
        resultsPanel.style.gridRow = '1 / -1';
    }
    
    if (count === 2) {
        // 2å†™æœ¬: æ¨ªä¸¦ã³ã€1è¡Œã§æœ€å¤§åŒ–
        container.style.gridTemplateColumns = '1fr 1fr 400px';
        container.style.gridTemplateRows = '1fr';
    } else if (count === 3) {
        // 3å†™æœ¬: æ¨ªä¸¦ã³ã€1è¡Œã§æœ€å¤§åŒ–
        container.style.gridTemplateColumns = '1fr 1fr 1fr 400px';
        container.style.gridTemplateRows = '1fr';
    } else if (count === 4) {
        // 4å†™æœ¬: 2Ã—2é…ç½®
        container.style.gridTemplateColumns = '1fr 1fr 400px';
        container.style.gridTemplateRows = '1fr 1fr';
    } else if (count === 5) {
        // 5å†™æœ¬: 3+2é…ç½®
        container.style.gridTemplateColumns = '1fr 1fr 1fr 400px';
        container.style.gridTemplateRows = '1fr 1fr';
    } else if (count === 6) {
        // 6å†™æœ¬: 3Ã—2é…ç½®
        container.style.gridTemplateColumns = '1fr 1fr 1fr 400px';
        container.style.gridTemplateRows = '1fr 1fr';
    } else if (count <= 8) {
        // 7-8å†™æœ¬: 4Ã—2é…ç½®
        container.style.gridTemplateColumns = '1fr 1fr 1fr 1fr 400px';
        container.style.gridTemplateRows = '1fr 1fr';
    } else if (count === 9) {
        // 9å†™æœ¬: 3Ã—3é…ç½®
        container.style.gridTemplateColumns = '1fr 1fr 1fr 400px';
        container.style.gridTemplateRows = '1fr 1fr 1fr';
    } else {
        // 10-12å†™æœ¬: 4Ã—3é…ç½®
        container.style.gridTemplateColumns = '1fr 1fr 1fr 1fr 400px';
        container.style.gridTemplateRows = '1fr 1fr 1fr';
    }
    
    // è¿½åŠ ãƒœã‚¿ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤º
    updateAddButton();
    
    // è§£æçµæœãƒ‘ãƒãƒ«ã®é«˜ã•ã‚’ç¢ºå®Ÿã«è¨­å®š
    setTimeout(() => {
        const resultsPanel = document.getElementById('manuscriptContainer').querySelector('.results-panel');
        if (resultsPanel) {
            resultsPanel.style.height = 'auto';
            resultsPanel.style.minHeight = '100%';
        }
    }, 0);
}

        function updateAddButton() {
            const container = document.getElementById('manuscriptContainer');
            let addButton = container.querySelector('.add-panel-btn');
            
            // è¿½åŠ ãƒœã‚¿ãƒ³ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯å‰Šé™¤
            if (addButton) {
                addButton.remove();
            }
        }

        function updateManuscriptCount() {
            const select = document.getElementById('manuscriptCountSelect');
            const newCount = parseInt(select.value);
            
            // ç¾åœ¨ã®ãƒ‘ãƒãƒ«æ•°ã¨æ¯”è¼ƒã—ã¦èª¿æ•´
            if (newCount > manuscriptPanels.length) {
                // ãƒ‘ãƒãƒ«ã‚’è¿½åŠ 
                while (manuscriptPanels.length < newCount) {
                    addManuscriptPanel();
                }
            } else if (newCount < manuscriptPanels.length) {
                // ãƒ‘ãƒãƒ«ã‚’å‰Šé™¤
                while (manuscriptPanels.length > newCount && manuscriptPanels.length > 2) {
                    const lastPanelId = manuscriptPanels[manuscriptPanels.length - 1];
                    const panel = document.getElementById(`panel${lastPanelId}`);
                    if (panel) {
                        panel.remove();
                    }
                    manuscriptPanels.pop();
                }
            }
            
            currentManuscriptCount = manuscriptPanels.length;
            updateManuscriptCountDisplay();
            updateGridLayoutDynamic();
            updateDialogRadioButtons();
            updateDiff();
        }

        function updateGridLayout(count) {
            // ã“ã®é–¢æ•°ã¯ updateGridLayoutDynamic ã«çµ±åˆã•ã‚Œã¾ã—ãŸ
            updateGridLayoutDynamic();
        }

        function generateManuscriptPanels(count) {
            const container = document.getElementById('manuscriptContainer');
            
            // æ—¢å­˜ã®å†™æœ¬ãƒ‘ãƒãƒ«ã‚’å‰Šé™¤ï¼ˆçµæœãƒ‘ãƒãƒ«ä»¥å¤–ï¼‰
            const existingPanels = container.querySelectorAll('.panel:not(.results-panel)');
            existingPanels.forEach(panel => panel.remove());
            const addButton = container.querySelector('.add-panel-btn');
            if (addButton) addButton.remove();
            
            // ãƒ‘ãƒãƒ«IDã‚’ãƒªã‚»ãƒƒãƒˆ
            manuscriptPanels = [];
            nextPanelId = 1;
            
            // æ–°ã—ã„ãƒ‘ãƒãƒ«ã‚’ç”Ÿæˆ
            for (let i = 1; i <= count; i++) {
                const panelId = i;
                manuscriptPanels.push(panelId);
                
                const panel = document.createElement('div');
                panel.className = 'panel';
                panel.id = `panel${panelId}`;
                
                panel.innerHTML = `
                    <div class="panel-header">
                        <input type="text" class="panel-title" value="${manuscriptNames[i-1]}" 
                               onchange="updateManuscriptName(${panelId}, this.value)" 
                               onblur="updateManuscriptName(${panelId}, this.value)"
                               placeholder="å†™æœ¬å">
                        <div class="panel-controls">
                            <button class="panel-btn" onclick="clearText(${panelId})">ã‚¯ãƒªã‚¢</button>
                            <button class="panel-btn" onclick="pasteFromClipboard(${panelId})">è²¼ä»˜</button>
                            ${count > 2 ? `<button class="panel-btn danger" onclick="removeManuscriptPanel(${panelId})" title="ã“ã®å†™æœ¬ã‚’å‰Šé™¤">Ã—</button>` : ''}
                        </div>
                    </div>
                    <div class="content">
                        <div class="line-numbers" id="lineNumbers${panelId}"></div>
                        <textarea class="textarea-input" id="text${panelId}" 
                                  placeholder="${manuscriptNames[i-1]}ã®ãƒ†ã‚­ã‚¹ãƒˆ..." 
                                  oninput="updateDiff(); updateStatus(${panelId})"></textarea>
                    </div>
                    <div class="status" id="status${panelId}">ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›</div>
                `;
                
                container.appendChild(panel);
                
                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
                document.getElementById(`text${panelId}`).addEventListener('input', function() {
                    updateLineNumbers(`text${panelId}`, `lineNumbers${panelId}`);
                    updateStatus(panelId);
                });
                
                // RTLç”¨ã®åˆæœŸã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’è¨­å®š
                setTimeout(() => {
                    const textarea = document.getElementById(`text${panelId}`);
                    if (textarea) {
                        textarea.scrollLeft = textarea.scrollWidth - textarea.clientWidth;
                    }
                }, 0);
                
                updateStatus(panelId);
            }
            
            nextPanelId = count + 1;
            currentManuscriptCount = count;
            updateAddButton();
            // ãƒ‘ãƒãƒ«ç”Ÿæˆå¾Œã«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’æ›´æ–°
            updateGridLayoutDynamic();
        }

        function updateManuscriptName(panelNumber, newName) {
            if (newName.trim()) {
                manuscriptNames[panelNumber - 1] = newName.trim();
                // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚‚æ›´æ–°
                const textarea = document.getElementById(`text${panelNumber}`);
                if (textarea) {
                    textarea.placeholder = `${newName}ã®ãƒ†ã‚­ã‚¹ãƒˆ...`;
                }
                updateDiff(); // çµæœè¡¨ç¤ºã‚‚æ›´æ–°
            }
        }

        function updateDialogRadioButtons() {
            const container = document.getElementById('manuscriptRadioButtons');
            container.innerHTML = '';
            
            manuscriptPanels.forEach((panelId, index) => {
                const label = document.createElement('label');
                const panelTitle = document.getElementById(`panel${panelId}`)?.querySelector('.panel-title')?.value || `å†™æœ¬${index + 1}`;
                label.innerHTML = `<input type="radio" name="target" value="text${panelId}" ${index === 0 ? 'checked' : ''}> ${panelTitle}`;
                container.appendChild(label);
            });
        }

        function updateLineNumbers(textareaId, lineNumbersId) {
            const textarea = document.getElementById(textareaId);
            const lineNumbers = document.getElementById(lineNumbersId);
            const lines = textarea.value.split('\n');
            const numbers = lines.map((_, index) => index + 1).join('\n');
            lineNumbers.textContent = numbers;
        }

        function clearText(panelNumber) {
            const textareaId = `text${panelNumber}`;
            const statusId = `status${panelNumber}`;
            const lineNumbersId = `lineNumbers${panelNumber}`;
            
            document.getElementById(textareaId).value = '';
            document.getElementById(statusId).textContent = 'ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ';
            document.getElementById(lineNumbersId).textContent = '';
            updateDiff();
        }

        function clearAllTexts() {
            manuscriptPanels.forEach(panelId => {
                clearText(panelId);
            });
            document.getElementById('resultsContent').textContent = 'å…¨ã¦ã®å†™æœ¬ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ';
        }

        async function pasteFromClipboard(panelNumber) {
            const textareaId = `text${panelNumber}`;
            const statusId = `status${panelNumber}`;
            const lineNumbersId = `lineNumbers${panelNumber}`;
            
            try {
                const text = await navigator.clipboard.readText();
                if (text) {
                    const textarea = document.getElementById(textareaId);
                    textarea.value = text;
                    document.getElementById(statusId).textContent = 'è²¼ã‚Šä»˜ã‘å®Œäº†';
                    updateLineNumbers(textareaId, lineNumbersId);
                    
                    // RTLç”¨ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’è¨­å®š
                    setTimeout(() => {
                        textarea.scrollLeft = textarea.scrollWidth - textarea.clientWidth;
                    }, 0);
                    
                    updateDiff();
                } else {
                    document.getElementById(statusId).textContent = 'ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ç©º';
                }
            } catch (err) {
                document.getElementById(statusId).textContent = 'Ctrl+Vã§è²¼ã‚Šä»˜ã‘';
            }
        }

        function updateStatus(panelNumber) {
            const textareaId = `text${panelNumber}`;
            const statusId = `status${panelNumber}`;
            const text = document.getElementById(textareaId).value;
            const lines = text.split('\n').length;
            const chars = text.length;
            
            if (chars === 0) {
                document.getElementById(statusId).textContent = 'ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›';
            } else {
                document.getElementById(statusId).textContent = `${lines}è¡Œ, ${chars}æ–‡å­—`;
            }
        }

        function loadSampleData() {
            // ç¾åœ¨ã®å†™æœ¬æ•°ã«å¿œã˜ã¦ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
            const baseSamples = [
                `Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø±Ø­ÙŠÙ…
Ø§Ù„Ø­Ù…Ø¯ Ù„Ù„Ù‡ Ø±Ø¨ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠÙ†
Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø±Ø­ÙŠÙ…
Ù…Ø§Ù„Ùƒ ÙŠÙˆÙ… Ø§Ù„Ø¯ÙŠÙ†
Ø¥ÙŠØ§Ùƒ Ù†Ø¹Ø¨Ø¯ ÙˆØ¥ÙŠØ§Ùƒ Ù†Ø³ØªØ¹ÙŠÙ†
Ø§Ù‡Ø¯Ù†Ø§ Ø§Ù„ØµØ±Ø§Ø· Ø§Ù„Ù…Ø³ØªÙ‚ÙŠÙ…`,
                `Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡ Ø§Ù„Ø±Ø­Ù…Ø§Ù† Ø§Ù„Ø±Ø­ÙŠÙ…
Ø§Ù„Ø­Ù…Ø¯ Ù„Ù„Ù‡ Ø±Ø¨ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠÙ†
Ø§Ù„Ø±Ø­Ù…Ø§Ù† Ø§Ù„Ø±Ø­ÙŠÙ…
Ù…Ù„Ùƒ ÙŠÙˆÙ… Ø§Ù„Ø¯ÙŠÙ†
Ø¥ÙŠØ§Ùƒ Ù†Ø¹Ø¨Ø¯ ÙˆØ¥ÙŠØ§Ùƒ Ù†Ø³ØªØ¹ÙŠÙ†
Ø§Ù‡Ø¯Ù†Ø§ Ø§Ù„ØµØ±Ø§Ø· Ø§Ù„Ù…Ø³ØªÙ‚ÙŠÙ…`,
                `Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø±Ø­ÙŠÙ…
Ø§Ù„Ø­Ù…Ø¯ Ù„Ù„Ù‡ Ø±Ø¨ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠÙ†
Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø±Ø­ÙŠÙ…
Ù…Ø§Ù„Ùƒ ÙŠÙˆÙ… Ø§Ù„Ø¯ÙŠÙ†
Ø§ÙŠØ§Ùƒ Ù†Ø¹Ø¨Ø¯ ÙˆØ§ÙŠØ§Ùƒ Ù†Ø³ØªØ¹ÙŠÙ†
Ø§Ù‡Ø¯Ù†Ø§ Ø§Ù„ØµØ±Ø§Ø· Ø§Ù„Ù…Ø³ØªÙ‚ÙŠÙ…`,
                `Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø±Ø­ÙŠÙ…
Ø§Ù„Ø­Ù…Ø¯ Ù„Ù„Ù‡ Ø±Ø¨ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠÙ†
Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø±Ø­ÙŠÙ…
Ù…Ø§Ù„Ùƒ ÙŠÙˆÙ… Ø§Ù„Ø¯ÙŠÙ†
Ø¥ÙŠØ§Ùƒ Ù†Ø¹Ø¨Ø¯ ÙˆØ¥ÙŠØ§Ùƒ Ù†Ø³ØªØ¹ÙŠÙ†
Ø§Ù‡Ø¯Ù†Ø§ Ø§Ù„ØµØ±Ø§Ø· Ø§Ù„Ù…Ø³ØªÙ‚ÙŠÙ…`,
                `Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø±Ø­ÙŠÙ…
Ø§Ù„Ø­Ù…Ø¯ Ù„Ù„Ù‡ Ø±Ø¨ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠÙ†
Ø§Ù„Ø±Ø­Ù…Ø§Ù† Ø§Ù„Ø±Ø­ÙŠÙ…
Ù…Ø§Ù„Ùƒ ÙŠÙˆÙ… Ø§Ù„Ø¯ÙŠÙ†
Ø¥ÙŠØ§Ùƒ Ù†Ø¹Ø¨Ø¯ ÙˆØ¥ÙŠØ§Ùƒ Ù†Ø³ØªØ¹ÙŠÙ†
Ø§Ù‡Ø¯Ù†Ø§ Ø§Ù„ØµØ±Ø§Ø· Ø§Ù„Ù…Ø³ØªÙ‚ÙŠÙ…`,
                `Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø±Ø­ÙŠÙ…
Ø§Ù„Ø­Ù…Ø¯ Ù„Ù„Ù‡ Ø±Ø¨ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠÙ†
Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø±Ø­ÙŠÙ…
Ù…Ù„Ùƒ ÙŠÙˆÙ… Ø§Ù„Ø¯ÙŠÙ†
Ø¥ÙŠØ§Ùƒ Ù†Ø¹Ø¨Ø¯ ÙˆØ¥ÙŠØ§Ùƒ Ù†Ø³ØªØ¹ÙŠÙ†
Ø§Ù‡Ø¯Ù†Ø§ Ø§Ù„ØµØ±Ø§Ø· Ø§Ù„Ù…Ø³ØªÙ‚ÙŠÙ…`
            ];

            for (let i = 0; i < currentManuscriptCount; i++) {
                const textareaId = `text${i + 1}`;
                const statusId = `status${i + 1}`;
                const lineNumbersId = `lineNumbers${i + 1}`;
                
                const sampleIndex = i % baseSamples.length;
                const textarea = document.getElementById(textareaId);
                const status = document.getElementById(statusId);
                
                if (textarea && status) {
                    textarea.value = baseSamples[sampleIndex];
                    status.textContent = 'ãƒ•ã‚¡ãƒ¼ãƒ†ã‚£ãƒç« ã‚µãƒ³ãƒ—ãƒ«';
                    updateLineNumbers(textareaId, lineNumbersId);
                    
                    // RTLç”¨ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’è¨­å®š
                    setTimeout(() => {
                        textarea.scrollLeft = textarea.scrollWidth - textarea.clientWidth;
                    }, 0);
                }
            }
            
            updateDiff();
        }

        function testArabicDisplay() {
            const basicTest = `Ù…Ø±Ø­Ø¨Ø§
Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…
Ø§Ù‡Ù„Ø§ ÙˆØ³Ù‡Ù„Ø§`;

            const textarea = document.getElementById('text1');
            textarea.value = basicTest;
            document.getElementById('status1').textContent = 'ã‚¢ãƒ©ãƒ“ã‚¢èªãƒ†ã‚¹ãƒˆ';
            updateLineNumbers('text1', 'lineNumbers1');
            
            // RTLç”¨ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’è¨­å®š
            setTimeout(() => {
                textarea.scrollLeft = textarea.scrollWidth - textarea.clientWidth;
            }, 0);
            
            updateDiff();
        }

        function updateDiff() {
            const texts = [];
            let hasContent = false;
            
            manuscriptPanels.forEach(panelId => {
                const textElement = document.getElementById(`text${panelId}`);
                if (textElement) {
                    const text = textElement.value;
                    texts.push(text.split('\n'));
                    if (text.trim()) hasContent = true;
                } else {
                    texts.push([]);
                }
            });
            
            if (!hasContent) {
                document.getElementById('resultsContent').textContent = 'å†™æœ¬ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦è§£æã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„';
                return;
            }
            
            const analysis = analyzeManuscripts(texts);
            displayResults(analysis);
        }

        function analyzeManuscripts(manuscripts) {
    // å…¨ã¦ã®å†™æœ¬ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’çµåˆã—ã¦å˜èªãƒªã‚¹ãƒˆã‚’ä½œæˆ
    const allWords = new Set();
    const manuscriptWords = manuscripts.map(ms => {
        const fullText = ms.join(' ').trim();
        const words = fullText ? fullText.split(/\s+/) : [];
        words.forEach(word => allWords.add(word));
        return words;
    });
    
    const results = [];
    const processedPositions = new Set();
    
    // å„å˜èªã«ã¤ã„ã¦ç•°èª­ã‚’ç¢ºèª
    Array.from(allWords).forEach(word => {
        if (!word.trim()) return;
        
        const wordVariants = new Map();
        const wordPositions = [];
        
        // å„å†™æœ¬ã§ã“ã®å˜èªã®ä½ç½®ã¨å‰å¾Œã®æ–‡è„ˆã‚’ç¢ºèª
        manuscriptWords.forEach((words, msIndex) => {
            words.forEach((w, wordIndex) => {
                if (w === word) {
                    // å‰å¾Œ2å˜èªã®æ–‡è„ˆã‚’å«ã‚ã‚‹
                    const contextStart = Math.max(0, wordIndex - 2);
                    const contextEnd = Math.min(words.length, wordIndex + 3);
                    const context = words.slice(contextStart, contextEnd).join(' ');
                    
                    const position = `${msIndex}-${wordIndex}`;
                    if (!processedPositions.has(position)) {
                        wordPositions.push({
                            manuscript: msIndex,
                            wordIndex: wordIndex,
                            context: context,
                            position: position
                        });
                    }
                }
            });
        });
        
        // æ–‡è„ˆãŒç•°ãªã‚‹å ´åˆã®ã¿ç•°èª­ã¨ã—ã¦è¨˜éŒ²
        if (wordPositions.length > 1) {
            const contextGroups = new Map();
            wordPositions.forEach(pos => {
                if (!contextGroups.has(pos.context)) {
                    contextGroups.set(pos.context, []);
                }
                contextGroups.get(pos.context).push(pos.manuscript);
                processedPositions.add(pos.position);
            });
            
            if (contextGroups.size > 1) {
                results.push({
                    word: word,
                    variants: Array.from(contextGroups.entries()).map(([context, manuscripts]) => ({
                        context: context,
                        manuscripts: manuscripts
                    })),
                    variantCount: contextGroups.size,
                    hasVariants: true
                });
            }
        }
    });
    
    // å®Œå…¨ã«ç•°ãªã‚‹ãƒ•ãƒ¬ãƒ¼ã‚ºã‚‚æ¤œå‡º
    const phraseResults = analyzePhrases(manuscripts);
    results.push(...phraseResults);
    
    return results.sort((a, b) => {
        // å˜èªã®å‡ºç¾é †ã§ã‚½ãƒ¼ãƒˆ
        const aFirstPos = getFirstWordPosition(a.word || a.phrase, manuscriptWords);
        const bFirstPos = getFirstWordPosition(b.word || b.phrase, manuscriptWords);
        return aFirstPos - bFirstPos;
    });
}

function analyzeManuscripts(manuscripts) {
    // å…¨ã¦ã®å†™æœ¬ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’çµåˆã—ã¦å˜èªãƒªã‚¹ãƒˆã‚’ä½œæˆ
    const allWords = new Set();
    const manuscriptWords = manuscripts.map(ms => {
        const fullText = ms.join(' ').trim();
        const words = fullText ? fullText.split(/\s+/) : [];
        words.forEach(word => allWords.add(word));
        return words;
    });
    
    const results = [];
    const processedPositions = new Set();
    
    // å„å˜èªã«ã¤ã„ã¦ç•°èª­ã‚’ç¢ºèª
    Array.from(allWords).forEach(word => {
        if (!word.trim()) return;
        
        const wordVariants = new Map();
        const wordPositions = [];
        
        // å„å†™æœ¬ã§ã“ã®å˜èªã®ä½ç½®ã¨å‰å¾Œã®æ–‡è„ˆã‚’ç¢ºèª
        manuscriptWords.forEach((words, msIndex) => {
            words.forEach((w, wordIndex) => {
                if (w === word) {
                    // å‰å¾Œ2å˜èªã®æ–‡è„ˆã‚’å«ã‚ã‚‹
                    const contextStart = Math.max(0, wordIndex - 2);
                    const contextEnd = Math.min(words.length, wordIndex + 3);
                    const context = words.slice(contextStart, contextEnd).join(' ');
                    
                    const position = `${msIndex}-${wordIndex}`;
                    if (!processedPositions.has(position)) {
                        wordPositions.push({
                            manuscript: msIndex,
                            wordIndex: wordIndex,
                            context: context,
                            position: position
                        });
                    }
                }
            });
        });
        
        // æ–‡è„ˆãŒç•°ãªã‚‹å ´åˆã®ã¿ç•°èª­ã¨ã—ã¦è¨˜éŒ²
        if (wordPositions.length > 1) {
            const contextGroups = new Map();
            wordPositions.forEach(pos => {
                if (!contextGroups.has(pos.context)) {
                    contextGroups.set(pos.context, []);
                }
                contextGroups.get(pos.context).push(pos.manuscript);
                processedPositions.add(pos.position);
            });
            
            if (contextGroups.size > 1) {
                results.push({
                    word: word,
                    variants: Array.from(contextGroups.entries()).map(([context, manuscripts]) => ({
                        context: context,
                        manuscripts: manuscripts
                    })),
                    variantCount: contextGroups.size,
                    hasVariants: true
                });
            }
        }
    });
    
    // å®Œå…¨ã«ç•°ãªã‚‹ãƒ•ãƒ¬ãƒ¼ã‚ºã‚‚æ¤œå‡º
    const phraseResults = analyzePhrases(manuscripts);
    results.push(...phraseResults);
    
    return results.sort((a, b) => {
        // å˜èªã®å‡ºç¾é †ã§ã‚½ãƒ¼ãƒˆ
        const aFirstPos = getFirstWordPosition(a.word || a.phrase, manuscriptWords);
        const bFirstPos = getFirstWordPosition(b.word || b.phrase, manuscriptWords);
        return aFirstPos - bFirstPos;
    });
}
        
function displayResults(analysis) {
    const resultsContent = document.getElementById('resultsContent');
    
    if (analysis.length === 0) {
        resultsContent.textContent = 'ç•°èª­ç®‡æ‰€ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ\n\nå…¨ã¦ã®å†™æœ¬ãŒä¸€è‡´ã—ã¦ã„ã¾ã™ã€‚';
        return;
    }
    
    let resultText = `ğŸ“Š ãƒ†ã‚­ã‚¹ãƒˆè§£æã‚µãƒãƒªãƒ¼\nç•°èª­ç®‡æ‰€: ${analysis.length}ç®‡æ‰€\n\n`;
    
    analysis.forEach((item, index) => {
        resultText += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
        
        if (item.word) {
            resultText += `ğŸ” å˜èªç•°èª­: "${item.word}" (${item.variantCount}ç¨®)\n\n`;
        } else if (item.phrase) {
            resultText += `ğŸ” å¥ç•°èª­: "${item.phrase}" (${item.variantCount}ç¨®)\n\n`;
        }
        
        let variantNum = 1;
        item.variants.forEach(variant => {
            const manuscriptLabels = variant.manuscripts.map(msIndex => {
                const panelId = manuscriptPanels[msIndex];
                return document.getElementById(`panel${panelId}`)?.querySelector('.panel-title')?.value || `å†™æœ¬${msIndex + 1}`;
            });
            
            resultText += `ğŸ“ ç•°èª­${variantNum}: ${manuscriptLabels.join('ãƒ»')}\n`;
            resultText += `   ã€Œ${variant.context}ã€\n\n`;
            variantNum++;
        });
    });
    
    resultsContent.textContent = resultText;
}
function updateTextOverlays(analysis) {
    // å„å†™æœ¬ãƒ‘ãƒãƒ«ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’æ›´æ–°
    manuscriptPanels.forEach((panelId, index) => {
        const textarea = document.getElementById(`text${panelId}`);
        const overlay = document.getElementById(`textOverlay${panelId}`);
        
        if (!textarea || !overlay) return;
        
        const fullText = textarea.value;
        const words = fullText.split(/(\s+)/); // ç©ºç™½ã‚‚ä¿æŒã—ã¦åˆ†å‰²
        let overlayHTML = '';
        
        // å„å˜èªã«ã¤ã„ã¦ç•°èª­ãƒã‚§ãƒƒã‚¯
        let wordIndex = 0;
        words.forEach((token, tokenIndex) => {
            if (token.match(/^\s+$/)) {
                // ç©ºç™½æ–‡å­—ã¯ãã®ã¾ã¾è¿½åŠ 
                overlayHTML += token;
            } else if (token.trim()) {
                // å®Ÿéš›ã®å˜èªã®å ´åˆ
                const highlightClass = getWordHighlightClass(token, wordIndex, index, analysis);
                if (highlightClass) {
                    overlayHTML += `<span class="${highlightClass}">${escapeHtml(token)}</span>`;
                } else {
                    overlayHTML += escapeHtml(token);
                }
                wordIndex++;
            } else {
                overlayHTML += escapeHtml(token);
            }
        });
        
        overlay.innerHTML = overlayHTML;
        syncOverlayScroll(panelId);
    });
}
function getWordHighlightClass(word, wordIndex, manuscriptIndex, analysis) {
    // ã“ã®å˜èªãŒç•°èª­ã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    for (const item of analysis) {
        if (item.word === word) {
            // å˜èªãƒ¬ãƒ™ãƒ«ã®ç•°èª­
            for (const variant of item.variants) {
                if (variant.manuscripts.includes(manuscriptIndex)) {
                    if (variant.manuscripts.length === 1) {
                        return 'unique-highlight';
                    } else if (variant.manuscripts.length < manuscriptPanels.length) {
                        return 'common-highlight';
                    } else {
                        return 'variant-highlight';
                    }
                }
            }
        } else if (item.phrase) {
            // ãƒ•ãƒ¬ãƒ¼ã‚ºãƒ¬ãƒ™ãƒ«ã®ç•°èª­
            const phraseWords = item.phrase.split(/\s+/);
            if (phraseWords.includes(word)) {
                for (const variant of item.variants) {
                    if (variant.manuscripts.includes(manuscriptIndex)) {
                        if (variant.manuscripts.length === 1) {
                            return 'unique-highlight';
                        } else if (variant.manuscripts.length < manuscriptPanels.length) {
                            return 'common-highlight';
                        } else {
                            return 'variant-highlight';
                        }
                    }
                }
            }
        }
    }
    return null;
}
        function exportResults() {
            const content = document.getElementById('resultsContent').textContent;
            const blob = new Blob([content], { type: 'text/plain; charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'å†™æœ¬ç•°èª­è§£æçµæœ.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function showTextInputDialog() {
            document.getElementById('textInputDialog').style.display = 'flex';
            document.getElementById('testTextInput').focus();
        }

        function closeTextInputDialog() {
            document.getElementById('textInputDialog').style.display = 'none';
        }

        function applyTestText() {
            const text = document.getElementById('testTextInput').value;
            const target = document.querySelector('input[name="target"]:checked').value;
            
            if (!text.trim()) {
                alert('ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const panelNumber = target.replace('text', '');
            document.getElementById(target).value = text;
            document.getElementById(`status${panelNumber}`).textContent = 'ã¾ã¨ã‚ã¦å…¥åŠ›å®Œäº†';
            updateLineNumbers(target, `lineNumbers${panelNumber}`);
            
            updateDiff();
            closeTextInputDialog();
        }

        // ESCã‚­ãƒ¼ã§ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeTextInputDialog();
            }
        });

        // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        document.getElementById('textInputDialog').addEventListener('click', function(e) {
            if (e.target === this) {
                closeTextInputDialog();
            }
        });

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // åˆæœŸçŠ¶æ…‹ã§6å†™æœ¬ã®ãƒ‘ãƒãƒ«ã‚’ç”Ÿæˆ
            generateManuscriptPanels(6);
            updateDialogRadioButtons();
            // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’æ˜ç¤ºçš„ã«è¨­å®š
            updateGridLayoutDynamic();
        });
    </script>
</body>
</html>
